# 调制信号数据集流式构造工具说明文档
## 文档概述
本文档针对**基于流式处理的调制信号数据集构造代码**进行详细说明，该工具专为大规模 `.bin`/`.wav` 格式 IQ 信号文件设计，核心实现 **50% 重叠采样** + **Float16 精度压缩** + **流式分块处理**，解决大文件加载的内存占用问题，适配 48G 内存/大存储环境，输出可直接用于调制识别模型训练的 `.npy` 格式数据集。

### 核心特性
1. **内存友好**：流式分块读取/写入，不一次性加载全量数据，避免几十G文件占满内存；
2. **数据增强**：50% 重叠采样（步长=2048），在不新增原始文件的前提下提升样本多样性；
3. **体积优化**：Float16 精度替代 Float32，数据集体积减半，显存占用同步减半；
4. **兼容适配**：支持 `.bin`/`.wav` 两种原始文件格式，修复 Windows 系统文件句柄/权限问题；
5. **可视化监控**：实时打印内存占用、样本分布，便于调试和资源评估。

### 适用场景
- 原始数据：`.bin`（按帧存储的 IQ 信号）/`.wav`（带头部的 IQ 信号）；
- 硬件环境：48G 内存服务器/工作站（也适配 16G/32G 内存，可调整分块大小）；
- 输出目标：生成形状为 `[N, 2, 4096]` 的 Float16 格式 IQ 信号数据集，含训练/验证/测试集划分。

## 一、核心配置参数详解
代码中 `Config` 类是数据集构造的核心配置入口，所有参数均可根据实际需求调整，参数说明如下：

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `DATA_DIR` | 字符串 | `../../DataSet` | 原始 `.bin`/`.wav` 信号文件目录（需修改为实际路径） |
| `DATASET_OUTPUT_DIR` | 字符串 | `./modulation_dataset_50overlap` | 最终数据集输出目录，自动创建 |
| `SAMPLE_LENGTH` | 整数 | 4096 | 单个 IQ 样本的长度（I/Q 双通道，每通道 4096 点） |
| `STRIDE` | 整数 | 2048 | 采样步长（50% 重叠：步长=样本长度/2），控制重叠比例 |
| `DTYPE` | numpy 类型 | `np.float16` | 输出数据精度，Float16 比 Float32 体积减半 |
| `CHUNK_SIZE` | 整数 | 100000 | 流式分块大小（每块样本数），内存不足时可减小该值 |
| `TEST_SIZE` | 浮点数 | 0.1 | 测试集比例（总样本的 10%） |
| `VAL_SIZE` | 浮点数 | 0.111 | 验证集比例（训练验证集的 11.1%，等效总样本的 10%） |
| `RANDOM_STATE` | 整数 | 42 | 随机种子，保证数据集划分可复现 |
| `PRINT_MEMORY_USAGE` | 布尔值 | `True` | 是否打印实时内存占用（调试用） |
| `PRINT_SAMPLE_DISTRIBUTION` | 布尔值 | `True` | 是否打印各调制类型样本分布（评估数据量用） |

## 二、代码模块功能说明
### 1. 辅助函数模块
#### （1）`print_memory_usage(step_name="")`
- 功能：实时打印当前进程的内存占用（单位：GB），便于监控流式处理过程中的内存变化；
- 触发条件：`Config.PRINT_MEMORY_USAGE=True` 时生效；
- 输出示例：`📊 内存占用 [train_chunk_0]：2.45 GB`。

#### （2）`print_sample_distribution(modulation_samples, label_encoder_mapping)`
- 功能：统计并打印各调制类型的样本总数、标签ID、文件数，直观展示数据分布；
- 触发条件：`Config.PRINT_SAMPLE_DISTRIBUTION=True` 时生效；
- 输出示例：
  ```
  📈 各调制类型样本分布汇总 (步长: 2048 | 50%重叠)
  调制类型        样本总数        标签ID   文件数   
  ------------------------------------------------------
  2FSK           120,000        0        5       
  16QAM          150,000        1        6       
  ...
  ```

### 2. 核心解析函数
#### （1）`get_file_iq_info(file_path)`
- 功能：解析单个 `.bin`/`.wav` 文件的元信息，无需读取全量数据，仅通过文件属性/命名规则提取关键信息；
- 解析内容：
  - 基础信息：文件名、文件类型（bin/wav）、调制类型（从文件名提取）、采样率；
  - 数据信息：IQ 对总数、有效 IQ 对数量、按步长估算的样本数；
  - 专属信息：`.bin` 文件提取帧大小、总帧数，`.wav` 文件跳过 1068 字节头部；
- 返回值：包含上述信息的字典（解析失败返回 `None`）。

#### （2）`stream_read_sample(file_info, start_idx)`
- 功能：按起始位置流式读取单个 IQ 样本，完成归一化 + Float16 转换；
- 核心逻辑：
  1. 计算文件读取偏移量（`.bin` 直接偏移，`.wav` 跳过 1068 字节头部）；
  2. 读取指定长度的 int16 原始数据（IQ 信号常见存储格式）；
  3. 补零处理（数据不足时）、归一化（除以 32767 映射到 [-1,1]）；
  4. 转换为 Float16 格式，返回形状为 `[4096, 2]` 的样本；
- 容错机制：文件不存在/读取失败时返回全零样本，避免流程中断。

### 3. 主函数（`construct_dataset_stream`）
整合数据集构造全流程，核心分为 4 个步骤，全程流式处理，无全量数据加载：

#### 步骤 1：解析文件信息
- 遍历原始文件目录，调用 `get_file_iq_info` 解析每个文件的元信息；
- 按调制类型分类，统计各类型的预估样本数；
- 生成调制类型-标签 ID 映射（`label_mapping.json`），保存到输出目录。

#### 步骤 2：生成索引并分块写入
- 为每个调制类型生成样本索引（文件路径 + 起始位置），避免重复读取文件；
- 按 `TEST_SIZE`/`VAL_SIZE` 分层划分训练/验证/测试集（保证各调制类型比例）；
- 流式读取样本，填充缓冲区，缓冲区达到 `CHUNK_SIZE` 时写入临时分块文件（`.npz` 压缩格式）。

#### 步骤 3：清理缓冲区
- 写入剩余未达到分块大小的样本，确保无数据丢失。

#### 步骤 4：合并分块并清理临时文件
- 合并同数据集（训练/验证/测试）的所有临时分块，生成最终的 `.npy` 文件；
- 关键修复：使用 `with` 上下文管理器加载 `.npz` 文件，确保加载后关闭文件句柄，解决 Windows 下删除临时文件的权限问题；
- 删除临时分块目录，释放存储空间。

## 三、关键优化点（适配大内存/Windows环境）
### 1. 50% 重叠采样优化
- 实现方式：步长 `STRIDE=2048`（样本长度 4096），每次滑动半个样本长度；
- 优势：在不增加原始文件的前提下，样本数提升约 1 倍，增强模型泛化能力，且避免步长=4096 时的样本信息遗漏。

### 2. 内存占用优化
- 流式分块：按 `CHUNK_SIZE` 分块处理，单块仅加载 10 万样本，内存占用控制在几 GB；
- 内存映射：仅读取文件元信息和单样本数据，不加载全量原始文件；
- Float16 压缩：输出数据为 Float16，相比 Float32 内存/磁盘占用减半。

### 3. Windows 系统兼容优化
- 文件句柄修复：加载临时分块文件时使用 `with` 上下文管理器，确保加载后关闭句柄，解决 `PermissionError`；
- 路径适配：自动转换文件路径分隔符（`/`→`\`），适配 Windows 路径规则；
- 强力清理：使用 `shutil.rmtree` 删除临时目录，解决单个文件删除失败的问题。

### 4. 数据容错优化
- 样本补零：读取数据长度不足时自动补零，保证样本形状统一；
- 解析容错：文件解析失败时跳过，不影响整体流程；
- 路径容错：文件路径不存在时，自动拼接原始目录重试。

## 四、运行步骤
### 1. 环境准备
安装依赖包（建议使用 Conda 环境）：
```bash
# 基础依赖
pip install numpy pandas scikit-learn tqdm psutil
```

### 2. 原始数据准备
#### （1）文件命名规则
需保证文件名包含调制类型、采样率、帧大小（`.bin` 文件），示例：
- `.bin` 文件：`2FSK_200kSPS_131072.bin`（调制类型_采样率_帧大小.bin）；
- `.wav` 文件：`16QAM_800kSPS.wav`（调制类型_采样率.wav）。

#### （2）目录结构
```
DataSet/  # 原始文件目录（对应 Config.DATA_DIR）
├── 2FSK_200kSPS_131072.bin
├── 16QAM_800kSPS.wav
├── QPSK_500kSPS_131072.bin
└── ...
```

### 3. 配置修改
修改 `Config` 类中的关键参数：
```python
class Config:
    DATA_DIR = "你的原始文件目录路径"  # 如：D:/modulation_raw_data
    DATASET_OUTPUT_DIR = "你的输出目录路径"  # 如：./modulation_dataset
    CHUNK_SIZE = 50000  # 内存不足时减小该值（如 50000）
```

### 4. 启动运行
```python
if __name__ == "__main__":
    construct_dataset_stream()
```
直接运行代码，控制台会打印处理进度、内存占用、样本分布等信息。

### 5. 结果验证
运行完成后，检查输出目录的文件完整性，核心文件包括：
```
modulation_dataset_50overlap/
├── label_mapping.json  # 调制类型-标签ID映射
├── train_data.npy      # 训练集数据（Float16, [N,2,4096]）
├── train_labels.npy    # 训练集标签（整数）
├── val_data.npy        # 验证集数据
├── val_labels.npy      # 验证集标签
├── test_data.npy       # 测试集数据
└── test_labels.npy     # 测试集标签
```

## 五、常见问题与解决方案
### 1. 原始文件解析失败（返回 None）
- 原因：
  1. 文件名不符合命名规则（如无调制类型/采样率）；
  2. `.bin` 文件未包含帧大小（文件名无 `_数字.bin` 后缀）；
  3. 文件损坏/路径错误；
- 解决方案：
  1. 检查文件名是否符合 `调制类型_采样率_帧大小.bin`/`调制类型_采样率.wav` 规则；
  2. 验证文件路径是否正确，`Config.DATA_DIR` 指向原始文件目录；
  3. 剔除损坏的文件，重新运行。

### 2. Windows 下临时文件删除失败
- 原因：文件句柄未关闭，导致 `os.remove` 报错 `PermissionError`；
- 解决方案：代码已内置修复（`with` 上下文管理器），无需手动操作；若仍失败，可手动删除 `temp_chunks` 目录。

### 3. 内存占用过高
- 原因：`CHUNK_SIZE` 过大，单块样本数超出内存承载能力；
- 解决方案：减小 `Config.CHUNK_SIZE`（如从 100000 改为 50000 或 20000），降低单块内存占用。

### 4. 样本数为 0
- 原因：
  1. 原始文件的 IQ 对总数小于样本长度（4096）；
  2. 步长设置不合理，导致有效起始位置为 0；
- 解决方案：
  1. 检查原始文件的有效数据长度，剔除过短的文件；
  2. 确认 `STRIDE` 小于 `SAMPLE_LENGTH`（建议保持 50% 重叠，`STRIDE=2048`）。

### 5. 输出文件形状异常
- 原因：样本读取时补零逻辑错误，或维度转换错误；
- 解决方案：
  1. 检查 `stream_read_sample` 函数返回的样本形状是否为 `[4096, 2]`；
  2. 确认分块合并时的维度转换：`transpose(0, 2, 1)` 保证最终形状为 `[N, 2, 4096]`。

## 六、输出结果说明
### 1. `label_mapping.json`
JSON 格式的调制类型-标签 ID 映射，示例：
```json
{
    "2FSK": 0,
    "16QAM": 1,
    "QPSK": 2,
    "8PSK": 3
}
```
用于模型训练时的标签解析，可直接加载到训练代码中。

### 2. `*_data.npy`
- 数据类型：Float16；
- 形状：`[N, 2, 4096]`（N 为样本数，2 为 I/Q 双通道，4096 为单通道长度）；
- 取值范围：归一化到 [-1, 1]，适配模型输入要求。

### 3. `*_labels.npy`
- 数据类型：整数；
- 形状：`[N,]`（N 为样本数）；
- 取值：对应 `label_mapping.json` 中的标签 ID，用于模型分类任务。

## 七、扩展建议
1. **自定义重叠比例**：修改 `STRIDE` 参数，如步长=1024（75% 重叠）、步长=4096（无重叠）；
2. **多线程加速**：在文件解析/样本读取环节增加多线程，提升处理速度（注意 Windows 多线程路径兼容）；
3. **数据增强**：在 `stream_read_sample` 中添加高斯噪声、相位偏移等增强逻辑；
4. **增量更新**：增加增量模式，仅处理新增的原始文件，无需重新构造全量数据集；
5. **压缩优化**：使用 `np.savez_compressed` 保存最终文件，进一步降低磁盘占用（需权衡读取速度）。

## 八、总结
本工具通过流式处理、50% 重叠采样、Float16 压缩等核心优化，解决了大规模调制信号数据集构造的内存占用、格式兼容、效率低下等问题，输出的数据集可直接对接调制识别模型训练代码，适配 48G 内存/Windows 环境，兼顾数据量、内存占用和训练效率。