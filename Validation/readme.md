# 调制信号识别模型推理验证程序说明文档
## 文档概述
本文档针对**YOLO12-1D 调制信号识别模型的推理验证程序**进行详细说明，该程序可直接读取原始 `.bin`/`.wav` 格式的 IQ 调制信号文件，加载训练好的模型权重完成推理预测，随机抽取指定数量文件验证模型泛化能力，并输出预测准确率、Top-N 结果等关键指标，是模型训练后效果验证的核心工具。

### 核心功能
1. **模型加载**：兼容训练代码输出的 `best_model.pth` 权重文件，自动适配标签映射（`label_mapping.json`）；
2. **原始文件预处理**：支持 `.bin`/`.wav` 格式，自动截取中间有效段、归一化、格式转换，无需提前构造数据集；
3. **推理验证**：输出 Top-3 预测结果及置信度，随机抽取文件测试并统计整体准确率；
4. **环境适配**：自动识别 CUDA/CPU 设备，兼容不同训练权重保存格式（纯 state_dict / 含指标的 checkpoint）。

### 适用场景
- 验证训练好的 YOLO12-1D 模型对原始信号文件的识别能力；
- 快速排查模型泛化性问题（如训练集过拟合、数据预处理不一致）；
- 批量测试不同调制类型信号的识别准确率。

## 一、核心配置参数详解
程序通过 `Config` 类集中管理核心配置，需根据实际环境修改，参数说明如下：

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `MODEL_PATH` | 字符串 | `../src/modulation_dataset_50overlap/best_model.pth` | 训练好的模型权重文件路径（`.pth`），支持纯 state_dict 或含 checkpoint 的文件 |
| `MAPPING_PATH` | 字符串 | `../src/modulation_dataset_50overlap/label_mapping.json` | 标签映射文件路径，兼容两种格式（直接字典 / 含 `label_to_idx` 的字典） |
| `RAW_DATA_DIR` | 字符串 | `../../DataSet` | 原始 `.bin`/`.wav` 信号文件目录，程序会遍历该目录下的所有对应格式文件 |
| `SAMPLE_LENGTH` | 整数 | 4096 | 单样本 IQ 长度，必须与训练时的样本长度一致 |
| `DEVICE` | torch.device | `cuda`（优先）/ `cpu` | 推理设备，自动检测 CUDA 可用性，无 GPU 时自动切换到 CPU |

## 二、代码模块功能说明
### 1. 模型定义模块
完全复用训练时的 YOLO12-1D 模型架构，**必须与训练代码一致**，否则会导致权重加载失败或推理结果错误。

#### 核心结构
- `Swish/SiLU` 激活函数：低版本 PyTorch 兼容 `Swish`，高版本使用原生 `SiLU`；
- `Backbone`：6 层 1D 卷积 + BN + 激活，完成时序特征提取；
- `Classifier`：全局平均池化 + 全连接层 + Dropout，输出分类概率；
- `forward` 方法：定义模型前向传播路径，与训练时完全一致。

### 2. 原始文件预处理模块（`load_and_preprocess_raw_file`）
核心功能：将原始 `.bin`/`.wav` 文件转换为模型可接收的输入张量，处理流程如下：

#### 处理步骤
1. **文件格式判断**：区分 `.bin`（直接读取）和 `.wav`（跳过 1068 字节头部）；
2. **长度校验**：确保文件包含的 IQ 对数量 ≥ 样本长度（4096），不足则返回失败；
3. **有效段截取**：截取文件中间段 IQ 数据（避免头尾噪声），也可改为随机截取；
4. **格式转换**：
   - 重塑形状：`[L×2,]`（原始 int16）→ `[L, 2]` → 转置为 `[2, L]`（适配模型输入维度）；
   - 归一化：int16 数据除以 32767，映射到 `[-1, 1]` 区间，转为 Float32；
   - 增加 Batch 维度：`[2, 4096]` → `[1, 2, 4096]`（模型要求批量输入）；
5. **容错处理**：读取失败/长度不足时返回 `None` 及错误信息，避免程序中断。

#### 输入输出
| 输入 | 说明 |
|------|------|
| `file_path` | 原始 `.bin`/`.wav` 文件路径 |
| `sample_length` | 单样本长度（默认 4096） |

| 输出 | 说明 |
|------|------|
| `input_tensor` | 模型输入张量（`[1, 2, 4096]`），失败则为 `None` |
| `msg` | 处理状态信息（成功/失败原因） |

### 3. 推理引擎模块（`InferenceEngine`）
封装模型加载、推理核心逻辑，提供统一的 `predict` 方法，核心步骤：

#### 初始化（`__init__`）
1. **加载标签映射**：读取 `label_mapping.json`，生成「标签 ID→调制类型」的反向映射，兼容两种 JSON 格式；
2. **模型初始化**：创建 YOLO12-1D 模型实例，加载到指定设备（CUDA/CPU）；
3. **权重加载**：
   - 兼容纯 state_dict 文件（直接加载）；
   - 兼容含指标的 checkpoint 文件（读取 `model_state_dict` 字段）；
4. **模型设为评估模式**：`model.eval()`，关闭 Dropout/BatchNorm 训练模式，保证推理稳定。

#### 推理预测（`predict`）
1. 调用 `load_and_preprocess_raw_file` 预处理文件，失败则返回错误信息；
2. 张量移至指定设备（CUDA/CPU）；
3. 推理计算：
   - `torch.no_grad()`：禁用梯度计算，节省内存并提升速度；
   - 前向传播得到输出，通过 `softmax` 转换为概率分布；
   - 计算推理耗时（毫秒级）；
4. Top-3 结果提取：返回置信度最高的 3 个调制类型及对应概率。

#### 输入输出
| 输入 | 说明 |
|------|------|
| `file_path` | 原始 `.bin`/`.wav` 文件路径 |

| 输出 | 说明 |
|------|------|
| `results` | Top-3 预测结果（列表，每个元素为 `(调制类型, 置信度)`），失败则为 `None` |
| `elapsed` | 推理耗时（毫秒），失败则为错误信息 |

### 4. 主程序模块
推理验证的入口，核心逻辑：
1. **前置检查**：验证模型文件、原始数据目录是否存在，缺失则退出；
2. **推理引擎初始化**：创建 `InferenceEngine` 实例，加载模型和标签映射；
3. **文件筛选与随机抽样**：遍历原始目录下的 `.bin`/`.wav` 文件，随机抽取 10 个测试；
4. **批量推理与结果统计**：
   - 从文件名提取真实标签（假设文件名格式为 `调制类型_xxxx.bin`）；
   - 调用 `predict` 方法获取预测结果；
   - 对比真实标签与 Top-1 预测结果，判断是否正确；
   - 输出详细结果（文件名、真实标签、Top-1 预测、置信度、对错状态）；
   - 错误时补充显示 Top-2/Top-3 结果，便于分析错误原因；
5. **准确率统计**：输出正确数/总数及整体准确率。

## 三、运行步骤
### 1. 环境准备
安装依赖包（与训练环境一致）：
```bash
pip install torch numpy json5 warnings
```

### 2. 配置修改
修改 `Config` 类中的路径参数，适配本地环境：
```python
class Config:
    # 改为本地模型权重路径
    MODEL_PATH = "D:/modulation_train/modulation_dataset_50overlap/best_model.pth"
    # 改为本地标签映射文件路径
    MAPPING_PATH = "D:/modulation_train/modulation_dataset_50overlap/label_mapping.json"
    # 改为原始信号文件目录
    RAW_DATA_DIR = "D:/modulation_raw_data"
```

### 3. 启动运行
直接执行程序：
```python
if __name__ == "__main__":
    # 程序自动完成以下操作：
    # 1. 加载模型和标签映射
    # 2. 随机抽取10个文件测试
    # 3. 输出预测结果和准确率
```

### 4. 结果示例
```
⏳ 正在初始化模型 (Device: cuda)...
✅ 模型权重加载成功

================================================================================
🚀 开始验证 (随机抽取 10 个原始文件)
================================================================================
文件名                              | 真实标签 (Guess)   | 预测结果 (Top-1)   | 置信度   | 结果
-----------------------------------------------------------------------------------------------
2FSK_200kSPS_131072.bin             | 2FSK              | 2FSK              | 99.8%    | ✅
16QAM_800kSPS.wav                   | 16QAM             | 16QAM             | 98.5%    | ✅
QPSK_500kSPS_131072.bin             | QPSK              | 8PSK              | 75.2%    | ❌
   ↳ Top-2: QPSK (22.1%) | Top-3: 16QAM (1.5%)
...
-----------------------------------------------------------------------------------------------
📊 统计: 正确 8/10 | 准确率: 80.0%
```

## 四、结果解读
### 1. 输出字段说明
| 字段 | 说明 |
|------|------|
| 文件名 | 测试的原始文件名称（超长时截断显示） |
| 真实标签 (Guess) | 从文件名提取的调制类型（需保证文件名格式规范） |
| 预测结果 (Top-1) | 模型置信度最高的调制类型预测结果 |
| 置信度 | Top-1 结果的置信度（0~100%） |
| 结果 | ✅（正确）/ ❌（错误） |
| Top-2/Top-3 | 错误时显示次高置信度的预测结果，便于分析错误原因 |

### 2. 关键指标
- **准确率**：正确预测数 / 总测试数，反映模型对原始文件的识别能力；
- **置信度**：越高说明模型对预测结果越确定，低置信度（<70%）可能表示模型对该样本识别模糊；
- **推理耗时**：单样本推理耗时（毫秒级），CUDA 环境下通常 <10ms，CPU 环境下约 50~100ms。

## 五、常见问题与解决方案
### 1. 模型加载失败
#### 原因
- 模型路径错误或文件损坏；
- 模型架构与训练时不一致（如卷积层参数、通道数修改）；
- 权重文件格式不兼容（如训练时用多 GPU 保存，推理时单 GPU 加载）。

#### 解决方案
- 验证 `MODEL_PATH` 路径正确性，重新下载/保存权重文件；
- 确保推理代码的模型定义与训练代码完全一致；
- 加载时添加 `map_location` 参数，适配单 GPU/CPU 环境：
  ```python
  checkpoint = torch.load(config.MODEL_PATH, map_location=torch.device('cpu'))
  ```

### 2. 原始文件读取失败
#### 原因
- 文件格式非 `.bin`/`.wav`；
- 文件损坏或长度过短（IQ 对 < 4096）；
- `.wav` 文件头部长度非 1068 字节。

#### 解决方案
- 筛选符合格式的文件，剔除损坏/过短文件；
- 若 `.wav` 文件头部长度不同，修改 `load_and_preprocess_raw_file` 中的 `seek(1068)` 为实际头部长度；
- 增加文件长度校验的容错逻辑，跳过无效文件。

### 3. 预测准确率低
#### 原因
- 训练集过拟合（训练集准确率高，测试原始文件准确率低）；
- 预处理不一致（如训练时归一化方式、样本截取位置与推理不同）；
- 文件名提取的真实标签错误（如文件名格式非 `调制类型_xxxx`）。

#### 解决方案
- 增加训练集数据增强（如噪声、相位偏移），降低过拟合；
- 统一训练/推理的预处理逻辑（如归一化、样本截取方式）；
- 手动核对文件名与真实调制类型，修正标签提取逻辑。

### 4. CUDA 内存不足
#### 原因
- GPU 显存被其他程序占用；
- 模型输入张量维度错误导致显存溢出。

#### 解决方案
- 关闭其他占用 GPU 的程序，或切换到 CPU 推理（修改 `DEVICE` 为 `cpu`）；
- 验证输入张量形状为 `[1, 2, 4096]`，避免维度错误。

## 六、扩展建议
### 1. 批量验证
修改主程序逻辑，遍历所有原始文件并输出详细报告：
```python
# 替换随机抽样为全量遍历
test_files = [f for f in os.listdir(config.RAW_DATA_DIR) if f.endswith(('.bin', '.wav'))]
```

### 2. 结果保存
将预测结果保存为 CSV 文件，便于后续分析：
```python
import csv
with open('inference_result.csv', 'w', newline='', encoding='utf-8') as f:
    writer = csv.writer(f)
    writer.writerow(['文件名', '真实标签', 'Top-1预测', 'Top-1置信度', 'Top-2预测', 'Top-2置信度', 'Top-3预测', 'Top-3置信度', '是否正确'])
    # 遍历文件写入结果
```

### 3. 多样本平均预测
对单个文件抽取多个位置的样本，取预测结果的平均值，提升准确率：
```python
# 修改 predict 方法，抽取5个样本取平均
def predict_multi_sample(self, file_path, n_samples=5):
    all_probs = []
    for _ in range(n_samples):
        input_tensor, msg = load_and_preprocess_raw_file(file_path, config.SAMPLE_LENGTH, random_start=True)
        # 推理并收集概率
        probs = torch.softmax(outputs, dim=1)
        all_probs.append(probs)
    # 计算平均概率
    avg_probs = torch.mean(torch.cat(all_probs), dim=0)
    # 提取 Top-3 结果
```

### 4. 可视化结果
添加混淆矩阵可视化，展示各调制类型的识别准确率：
```python
from sklearn.metrics import confusion_matrix
import matplotlib.pyplot as plt

# 收集所有真实标签和预测标签
y_true = []
y_pred = []
for filename in test_files:
    ground_truth = filename.split('_')[0]
    results, _ = engine.predict(file_path)
    y_true.append(ground_truth)
    y_pred.append(results[0][0])

# 绘制混淆矩阵
cm = confusion_matrix(y_true, y_pred, labels=list(engine.idx_to_label.values()))
plt.figure(figsize=(10, 8))
plt.imshow(cm, interpolation='nearest', cmap=plt.cm.Blues)
# 添加标签、颜色条等
plt.show()
```

## 七、总结
本推理验证程序是 YOLO12-1D 调制信号识别模型的配套工具，核心价值在于**无需构造数据集即可直接验证原始信号文件的识别效果**，帮助快速评估模型泛化能力。程序通过模块化设计实现了模型加载、文件预处理、推理预测、结果统计的全流程，兼容不同文件格式、权重格式和硬件环境，是模型训练后效果验证的核心工具。通过扩展批量验证、结果保存、可视化等功能，可进一步提升验证效率和分析深度。